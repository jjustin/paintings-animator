<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animate</title>
    <link rel="stylesheet" href="stylesheet.css">

</head>

<body>
    <div id="container">
        <div id="image-picker">
            <div class="image" id="addImage">+</div>

            <script>
                async function getArray() {
                    return await fetch("http://localhost:5000/images").then(response => response.json())
                }

                async function loadImages() {
                    var obj = await getArray()
                    console.log(obj)
                    var arr = obj.images
                    var processing = obj.processing

                    for (img of processing) {
                        const image = document.createElement('img')
                        image.src = '/images/processing/' + img
                        image.classList.add("processing")
                        full_name = img
                        img_n = img.split('.')
                        image.id = img_n[0]
                        image.name = img_n[0]

                        document.querySelector('#image-picker').appendChild(image)
                        // keep checking if file exists
                        let checkForChange = async () => {
                            let exists = await fetch(`http://localhost:5000/exists/${full_name}`).then(x => x.text()).then(x => x == 'true')
                            console.log(exists)
                            if (exists) {
                                image.classList.remove("processing")
                                image.classList.add("image")
                                image.addEventListener('click', () => {
                                    onImageClick(image)
                                })
                            }
                            else {
                                setTimeout(checkForChange, 5000)
                            }
                        }
                        setTimeout(checkForChange, 5000)
                    }

                    for (img of arr) {
                        const image = document.createElement('img')
                        image.src = '/images/' + img
                        image.classList.add("image")
                        img_n = img.split('.')
                        image.id = img_n[0]
                        image.name = img_n[0]

                        document.querySelector('#image-picker').appendChild(image)

                    }

                }

                loadOnImageClick = () => {
                    images = document.getElementsByClassName('image')
                    for (let image of images) {
                        if (image.id == "addImage") {
                            image.addEventListener('click', addNewImage)
                            continue;
                        }
                        image.addEventListener('click', () => {
                            onImageClick(image)
                        })
                    }
                }

                onImageClick = (image) => {
                    var exSelectedImages = document.getElementsByClassName("image selected")
                    // Remove selected class
                    for (let item of exSelectedImages) {
                        item.classList.remove("selected")
                    }
                    image.classList.add("selected")
                    selected_img = image.id

                    let overlay = document.createElement('div')
                    overlay.classList.add("overlay")
                    overlay.innerHTML = "Selected"
                    image.appendChild(overlay)

                    changeVideo()

                }

                addNewImage = () => {
                    console.log("Opening file")
                    var input = document.createElement('input');
                    input.type = 'file';
                    // Handle file upload

                    input.onchange = async e => {
                        var file = e.target.files[0];
                        const formData = new FormData()
                        formData.append('file', file)

                        response = await fetch("http://localhost:5000/addImage", { method: "PUT", body: formData }).then(x => x.json())

                        if (response.error) {
                            alert("Error: " + response.error)
                            return;
                        }

                        location.reload()
                    }

                    input.click();
                }

                // Load images and add listeners to each of them
                loadImages().then(loadOnImageClick)
            </script>
        </div>

        <div id="video-picker">
            <!-- not done - change ids as the name of the corresponding video -->
            <input type="image" src="emoji/angry.png" name="angry" class="emojiImage" id="angry"
                onclick="selectEmoji(this)">
            <input type="image" src="emoji/sad.png" name="sad" class="emojiImage" id="sad" onclick="selectEmoji(this)">
            <input type="image" src="emoji/smile.png" name="smile" class="emojiImage" id="input4"
                onclick="selectEmoji(this)">

            <script>
                var selected_img = ''
                var selected_emoji = ''

                function changeVideo() {
                    console.log("Emoji:", selected_emoji, "Image:", selected_img)
                    if (selected_emoji != '' && selected_img != '') {
                        var output = document.getElementById("video")
                        var source = document.getElementById("source")

                        // output.pause()
                        source.src = "output/output_" + selected_emoji + "_" + selected_img + ".mp4"
                        output.load()
                        output.play()
                    }
                }

                function selectEmoji(emoji) {
                    var exSelectedEmojis = document.getElementsByClassName("emojiImage selected")
                    // Remove selected class
                    for (let item of exSelectedEmojis) {
                        item.classList.remove("selected")
                    }
                    emoji.classList.add("selected")
                    selected_emoji = emoji.id

                    changeVideo()
                }

            </script>
        </div>

        <div id="result">
            <video class="result-video" autoplay="autoplay" id="video" muted loop>
                <source id="source" src="output/video1.mp4" type="video/mp4">
            </video>
        </div>
    </div>
</body>

</html>
